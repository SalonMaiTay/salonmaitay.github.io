<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Quản lý Salon</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 (Màu nền mới) */
        }
        
        /* Ẩn thanh cuộn */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        
        /* CSS cho Modal: Ẩn mặc định */
        .modal {
            display: none; 
        }
        
        /* (MỚI) CSS cho Nút Sidebar Active */
        .admin-nav-button.active {
            background-color: #eef2ff; /* bg-indigo-50 */
            color: #4f46e5; /* text-indigo-600 */
            font-weight: 600;
        }
        .admin-nav-button.active i {
            color: #4f46e5; /* text-indigo-600 */
        }
        
        /* Tùy chỉnh input cho file */
        input[type="file"]::file-selector-button {
            margin-right: 0.5rem;
            border: none;
            background: #4f46e5; /* bg-indigo-600 (Đổi màu) */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background: #4338ca; /* bg-indigo-700 (Đổi màu) */
        }
    </style>
</head>
<body>

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 to-white p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl">
            <div class="flex justify-center mb-4">
                <i class="fas fa-cut text-5xl text-indigo-600"></i>
            </div>
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">Salon Admin</h2>
            <div class="space-y-5">
                <div>
                    <label for="admin-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="admin-email" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="admin@salon.com">
                </div>
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700">Mật khẩu</label>
                    <input type="password" id="admin-password" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="••••••••">
                </div>
                <p id="login-error" class="text-sm text-red-600 hidden">Email hoặc mật khẩu không đúng.</p>
                <button id="login-button" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-medium shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 text-base">
                    Đăng nhập
                </button>
            </div>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden">
        <div class="flex h-screen bg-slate-50">
            
            <div id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white text-gray-800 p-4 space-y-2 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-30 border-r border-gray-200">
                <h1 class="text-2xl font-bold mb-4 text-indigo-600 px-2">Quản lý Salon</h1>
                <nav class="space-y-1">
                    <button data-page="page-dashboard" class="w-full text-left admin-nav-button flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-home w-6 text-center text-gray-400 mr-2"></i> Tổng quan
                    </button>
                    <button data-page="page-bookings" class="w-full text-left admin-nav-button flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-calendar-alt w-6 text-center text-gray-400 mr-2"></i> Quản lý Lịch hẹn
                    </button>
                    <button data-page="page-technicians" class="w-full text-left admin-nav-button flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-user-tie w-6 text-center text-gray-400 mr-2"></i> Quản lý Nhân sự
                    </button>
                    <button data-page="page-branches" class="w-full text-left admin-nav-button flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-store w-6 text-center text-gray-400 mr-2"></i> Quản lý Chi nhánh
                    </button>
                    <button data-page="page-news" class="w-full text-left admin-nav-button flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-newspaper w-6 text-center text-gray-400 mr-2"></i> Quản lý Tin tức
                    </button>
                    <button data-page="page-gallery" class="w-full text-left admin-nav-button flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-images w-6 text-center text-gray-400 mr-2"></i> Quản lý Bộ sưu tập
                    </button>
                    <button data-page="page-reviews" class="w-full text-left admin-nav-button flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-star w-6 text-center text-gray-400 mr-2"></i> Quản lý Đánh giá
                    </button>
                    <button data-page="page-crm" class="w-full text-left admin-nav-button flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-users w-6 text-center text-gray-400 mr-2"></i> Quản lý Khách hàng
                    </button>
                </nav>
                <button id="logout-button" class="absolute bottom-4 left-4 right-4 w-auto text-left flex items-center px-3 py-2 rounded-lg text-gray-600 hover:bg-red-50 hover:text-red-600">
                    <i class="fas fa-sign-out-alt w-6 text-center mr-2"></i> Đăng xuất
                </button>
            </div>
            
            <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 z-20 hidden md:hidden" onclick="toggleSidebar()"></div>

            <div class="flex-1 flex flex-col md:ml-64">
                
                <header class="md:hidden bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10">
                    <button id="menu-toggle" class="text-gray-800" onclick="toggleSidebar()">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h2 class="text-xl font-bold" id="admin-page-title">Tổng quan</h2>
                    <div class="w-6"></div> </header>
                
                <main class="flex-1 p-6 md:p-8 overflow-y-auto">
                    
                    <div id="page-dashboard" class="admin-page-content space-y-6">
                        <h2 class="text-3xl font-bold text-gray-900 hidden md:block">Chào mừng, Admin!</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
                                        <i class="fas fa-calendar-check fa-lg"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Lịch hẹn Hôm nay</p>
                                        <p class="text-2xl font-bold text-gray-900" id="stat-today-bookings">...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                        <i class="fas fa-clock fa-lg"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Chờ xác nhận</p>
                                        <p class="text-2xl font-bold text-gray-900" id="stat-pending-bookings">...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                                        <i class="fas fa-user-tie fa-lg"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Tổng Nhân sự</p>
                                        <p class="text-2xl font-bold text-gray-900" id="stat-total-techs">...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                                <div class="flex items-center space-x-3">
                                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                        <i class="fas fa-star fa-lg"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Tổng Đánh giá</p>
                                        <p class="text-2xl font-bold text-gray-900" id="stat-new-reviews">...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Truy cập nhanh</h3>
                            <div class="flex flex-wrap gap-3">
                                <button data-page="page-bookings" class="admin-nav-button-quick bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 text-sm font-medium">
                                    <i class="fas fa-calendar-alt mr-1"></i> Xem Lịch hẹn
                                </button>
                                <button id="quick-add-booking" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 text-sm font-medium">
                                    <i class="fas fa-plus mr-1"></i> Thêm lịch hẹn
                                </button>
                                <button id="quick-add-tech" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 text-sm font-medium">
                                    <i class="fas fa-user-plus mr-1"></i> Thêm Nhân sự
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="page-bookings" class="admin-page-content space-y-5 hidden">
                        <h2 class="text-3xl font-bold text-gray-900 hidden md:block">Quản lý Lịch hẹn</h2>
                        
                        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                            <button id="open-manual-booking-modal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 text-sm font-medium">
                                <i class="fas fa-plus mr-1"></i> Thêm lịch hẹn
                            </button>
                            <button id="open-block-slot-modal" class="bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-yellow-600 text-sm font-medium">
                                <i class="fas fa-clock-slash mr-1"></i> Thêm lịch bận
                            </button>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm border border-yellow-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">
                                <i class="fas fa-clock text-yellow-600 mr-1"></i> Lịch hẹn Mới (Chờ xác nhận)
                            </h3>
                            <div id="new-bookings-container" class="space-y-3">
                                <p class="text-center text-gray-500">Đang tải lịch hẹn mới...</p>
                                </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900">Tất cả Lịch hẹn</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="booking-branch-filter" class="block text-sm font-medium text-gray-700">Chi nhánh</label>
                                    <select id="booking-branch-filter" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="all">Tất cả chi nhánh</option>
                                        </select>
                                </div>
                                <div>
                                    <label for="booking-date-filter-select" class="block text-sm font-medium text-gray-700">Lọc theo ngày</label>
                                    <select id="booking-date-filter-select" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="today">Hôm nay</option>
                                        <option value="recent">Gần đây (7 ngày tới)</option>
                                        <option value="this_month">Tháng này</option>
                                        <option value="all">Tất cả</option>
                                        <option value="specific_date">Ngày cụ thể</option>
                                    </select>
                                    <input type="date" id="booking-date-filter-specific" class="mt-2 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 hidden">
                                </div>
                                <div>
                                    <label for="booking-search" class="block text-sm font-medium text-gray-700">Tìm kiếm</label>
                                    <input type="text" id="booking-search" placeholder="Tên, SĐT, Mã đặt..." class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                            <div class="border-t pt-4">
                                <h3 class="text-md font-semibold text-gray-800">Điều chỉnh số ghế (Khách vãng lai)</h3>
                                <p class="text-sm text-gray-500 mb-2">Chỉ áp dụng cho chi nhánh và ngày đã chọn (nếu là ngày cụ thể).</p>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="temp-used-seats" min="0" placeholder="Số ghế đã dùng" class="block w-40 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <button id="save-temp-seats" class="bg-gray-700 text-white px-4 py-2 rounded-lg shadow-md hover:bg-gray-800 text-sm font-medium">
                                        Lưu
                                    </button>
                                </div>
                                <p id="temp-seats-status" class="text-sm text-green-600 mt-1 hidden"></p>
                            </div>
                        </div>

                        <div id="booking-list-container" class="space-y-3">
                            <p class="text-center text-gray-500">Đang tải lịch hẹn...</p>
                            </div>
                    </div>
                    
                    <div id="page-technicians" class="admin-page-content space-y-5 hidden">
                        <div class="flex justify-between items-center">
                            <h2 class="text-3xl font-bold text-gray-900 hidden md:block">Quản lý Nhân sự</h2>
                            <button id="open-technician-modal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700">
                                <i class="fas fa-plus mr-1"></i> Thêm Nhân sự
                            </button>
                        </div>
                        <div id="technician-list-container" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                            <p class="text-center text-gray-500 p-4">Đang tải nhân sự...</p>
                            </div>
                    </div>

                    <div id="page-branches" class="admin-page-content space-y-5 hidden">
                        <div class="flex justify-between items-center">
                            <h2 class="text-3xl font-bold text-gray-900 hidden md:block">Quản lý Chi nhánh</h2>
                            <button id="open-branch-modal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700">
                                <i class="fas fa-plus mr-1"></i> Thêm Chi nhánh
                            </button>
                        </div>
                        <div id="branch-list-container" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                            <p class="text-center text-gray-500 p-4">Đang tải chi nhánh...</p>
                            </div>
                    </div>
                    
                    <div id="page-news" class="admin-page-content space-y-5 hidden">
                        <div class="flex justify-between items-center">
                            <h2 class="text-3xl font-bold text-gray-900 hidden md:block">Quản lý Tin tức & Ưu đãi</h2>
                            <button id="open-news-modal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700">
                                <i class="fas fa-plus mr-1"></i> Thêm Bài viết
                            </button>
                        </div>
                        <div id="news-list-container" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <p class="text-center text-gray-500">Đang tải bài viết...</p>
                            </div>
                    </div>

                    <div id="page-gallery" class="admin-page-content space-y-5 hidden">
                        <div class="flex justify-between items-center">
                            <h2 class="text-3xl font-bold text-gray-900 hidden md:block">Quản lý Bộ sưu tập</h2>
                             <button id="open-gallery-modal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700">
                                <i class="fas fa-plus mr-1"></i> Thêm ảnh
                            </button>
                        </div>
                        <div id="gallery-list-container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <p class="text-center text-gray-500 col-span-full">Đang tải bộ sưu tập...</p>
                            </div>
                    </div>

                    <div id="page-reviews" class="admin-page-content space-y-5 hidden">
                        <h2 class="text-3xl font-bold text-gray-900 hidden md:block">Quản lý Đánh giá</h2>
                        <div id="review-list-container" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <p class="text-center text-gray-500">Đang tải đánh giá...</p>
                            </div>
                    </div>

                    <div id="page-crm" class="admin-page-content space-y-5 hidden">
                        <h2 class="text-3xl font-bold text-gray-900 hidden md:block">Quản lý Khách hàng (CRM)</h2>
                        
                        <div class="flex flex-wrap gap-3">
                            <button id="open-customer-modal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 text-sm font-medium">
                                <i class="fas fa-user-plus mr-1"></i> Thêm Khách hàng
                            </button>
                            <button id="sync-customers" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 text-sm font-medium">
                                <i class="fas fa-sync mr-1"></i> Đồng bộ từ Lịch hẹn
                            </button>
                            <button id="export-customers" class="bg-gray-700 text-white px-4 py-2 rounded-lg shadow-md hover:bg-gray-800 text-sm font-medium">
                                <i class="fas fa-download mr-1"></i> Tải xuống (JSON)
                            </button>
                            <button id="import-customers" class="bg-gray-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-gray-600 text-sm font-medium">
                                <i class="fas fa-upload mr-1"></i> Tải lên (JSON)
                            </button>
                            <input type="file" id="customer-file-input" class="hidden" accept=".json">
                        </div>

                        <div id="customer-list-container" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
                            <p class="text-center text-gray-500 p-4">Đang tải danh sách khách hàng...</p>
                            </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="modal-alert" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50">
      <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm">
        <h3 id="modal-alert-title" class="text-lg font-medium text-gray-900">Thông báo</h3>
        <p id="modal-alert-message" class="text-sm text-gray-600 mt-2">Nội dung...</p>
        <div class="mt-4 flex justify-end">
          <button id="modal-alert-close" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">Đã hiểu</button>
        </div>
      </div>
    </div>
    
    <div id="modal-confirm" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50">
      <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm">
        <h3 id="modal-confirm-title" class="text-lg font-medium text-gray-900">Xác nhận</h3>
        <p id="modal-confirm-message" class="text-sm text-gray-600 mt-2">Bạn có chắc chắn?</p>
        <div class="mt-4 flex justify-end space-x-2">
          <button id="modal-confirm-cancel" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50">Huỷ bỏ</button>
          <button id="modal-confirm-ok" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700">Xác nhận</button>
        </div>
      </div>
    </div>

    <div id="modal-edit-branch" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-40">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg overflow-y-auto max-h-screen">
            <h3 id="branch-modal-title" class="text-xl font-bold mb-4">Thêm Chi nhánh</h3>
            <form id="branch-form" class="space-y-4">
                <input type="hidden" id="branch-id">
                <div>
                    <label for="branch-name" class="block text-sm font-medium text-gray-700">Tên chi nhánh</label>
                    <input type="text" id="branch-name" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="branch-address" class="block text-sm font-medium text-gray-700">Địa chỉ</label>
                    <input type="text" id="branch-address" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="branch-phone" class="block text-sm font-medium text-gray-700">Liên hệ</label>
                    <input type="tel" id="branch-phone" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="branch-opening-time" class="block text-sm font-medium text-gray-700">Giờ mở cửa</label>
                        <input type="time" id="branch-opening-time" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" step="1800">
                    </div>
                    <div>
                        <label for="branch-closing-time" class="block text-sm font-medium text-gray-700">Giờ đóng cửa</label>
                        <input type="time" id="branch-closing-time" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" step="1800">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="branch-total-seats" class="block text-sm font-medium text-gray-700">Tổng số ghế</label>
                        <input type="number" id="branch-total-seats" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" min="1">
                    </div>
                </div>
                <div class="border-t pt-4">
                    <button type="button" id="open-special-schedule-modal" class="w-full bg-yellow-500 text-white px-4 py-2 rounded-lg shadow hover:bg-yellow-600 text-sm font-medium">
                        <i class="fas fa-calendar-times mr-1"></i> Thiết lập Lịch đặc biệt (Tạm nghỉ)
                    </button>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="close-branch-modal" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">Huỷ</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Lưu</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modal-special-schedule" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Thiết lập Lịch đặc biệt (Tạm nghỉ)</h3>
            <form id="special-schedule-form" class="space-y-4">
                <input type="hidden" id="special-schedule-branch-id">
                <div>
                    <label for="schedule-start-date" class="block text-sm font-medium text-gray-700">Ngày bắt đầu nghỉ</label>
                    <input type="date" id="schedule-start-date" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="schedule-num-days" class="block text-sm font-medium text-gray-700">Số ngày nghỉ</label>
                    <input type="number" id="schedule-num-days" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" min="1" value="1" required>
                </div>
                <div>
                    <label for="schedule-note" class="block text-sm font-medium text-gray-700">Ghi chú (hiển thị cho khách)</label>
                    <input type="text" id="schedule-note" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" value="Tạm nghỉ">
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="close-special-schedule-modal" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">Huỷ</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Lưu Lịch</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-edit-technician" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-40">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg overflow-y-auto max-h-screen">
            <h3 id="technician-modal-title" class="text-xl font-bold mb-4">Thêm Nhân sự</h3>
            <form id="technician-form" class="space-y-4">
                <input type="hidden" id="technician-id">
                <div>
                    <label for="technician-name" class="block text-sm font-medium text-gray-700">Tên nhân sự</label>
                    <input type="text" id="technician-name" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="technician-title" class="block text-sm font-medium text-gray-700">Chức vụ (ví dụ: Stylist, Học viên)</label>
                    <input type="text" id="technician-title" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="technician-experience" class="block text-sm font-medium text-gray-700">Số năm kinh nghiệm</label>
                    <input type="number" id="technician-experience" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" min="0">
                </div>
                <div>
                    <label for="technician-photourl" class="block text-sm font-medium text-gray-700">Link ảnh đại diện</label>
                    <input type="text" id="technician-photourl" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://...">
                </div>
                <div>
                    <label for="technician-branch" class="block text-sm font-medium text-gray-700">Chi nhánh</label>
                    <select id="technician-branch" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </select>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="close-technician-modal" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">Huỷ</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Lưu</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modal-edit-news" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-40">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-2xl overflow-y-auto max-h-screen">
            <h3 id="news-modal-title" class="text-xl font-bold mb-4">Thêm Bài viết / Ưu đãi</h3>
            <form id="news-form" class="space-y-4">
                <input type="hidden" id="news-id">
                <div>
                    <label for="news-title" class="block text-sm font-medium text-gray-700">Tiêu đề</label>
                    <input type="text" id="news-title" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="news-type" class="block text-sm font-medium text-gray-700">Loại bài</label>
                    <select id="news-type" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="news">Tin tức (Bài viết)</option>
                        <option value="offer">Ưu đãi (Khuyến mãi)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nội dung</label>
                    <div class="flex space-x-2 mb-1">
                        <button type="button" data-content-type="text" class="news-content-type-btn bg-indigo-600 text-white px-3 py-1 rounded-md text-sm">Viết chữ</button>
                        <button type="button" data-content-type="html" class="news-content-type-btn bg-gray-200 text-gray-800 px-3 py-1 rounded-md text-sm">Viết HTML</button>
                    </div>
                    <textarea id="news-content-text" rows="10" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Viết nội dung..."></textarea>
                    <textarea id="news-content-html" rows="10" class="mt-1 block w-full border-gray-300 rounded-lg font-mono text-sm hidden focus:ring-indigo-500 focus:border-indigo-500" placeholder="<p>Viết mã <b>HTML</b>...</p>"></textarea>
                    <input type="hidden" id="news-content-mode" value="text">
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="close-news-modal" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">Huỷ</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Đăng bài</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modal-manual-booking" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-40">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg overflow-y-auto max-h-screen">
            <h3 class="text-xl font-bold mb-4">Thêm Lịch hẹn Thủ công</h3>
            <form id="manual-booking-form" class="space-y-4">
                <div>
                    <label for="manual-branch" class="block text-sm font-medium text-gray-700">Chi nhánh</label>
                    <select id="manual-branch" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                        </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="manual-date" class="block text-sm font-medium text-gray-700">Ngày</label>
                        <input type="date" id="manual-date" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="manual-time" class="block text-sm font-medium text-gray-700">Giờ</label>
                        <input type="time" id="manual-time" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" step="1800" required>
                    </div>
                </div>
                <div>
                    <label for="manual-technician" class="block text-sm font-medium text-gray-700">Kỹ thuật viên</label>
                    <select id="manual-technician" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="any">Để salon sắp xếp</option>
                        </select>
                </div>
                <div class="border-t pt-4 space-y-4">
                     <div>
                        <label for="manual-client-name" class="block text-sm font-medium text-gray-700">Tên khách hàng</label>
                        <input type="text" id="manual-client-name" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                     <div>
                        <label for="manual-client-contact" class="block text-sm font-medium text-gray-700">Liên hệ (SĐT/Zalo...)</label>
                        <input type="text" id="manual-client-contact" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="close-manual-booking-modal" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">Huỷ</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Lưu Lịch hẹn</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modal-block-slot" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-40">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4">Thêm Lịch Bận (Block thời gian)</h3>
            <form id="block-slot-form" class="space-y-4">
                <div>
                    <label for="block-branch" class="block text-sm font-medium text-gray-700">Chi nhánh</label>
                    <select id="block-branch" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                        </select>
                </div>
                <div>
                    <label for="block-date" class="block text-sm font-medium text-gray-700">Ngày</label>
                    <input type="date" id="block-date" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="block-start-time" class="block text-sm font-medium text-gray-700">Từ (Giờ)</label>
                        <input type="time" id="block-start-time" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" step="1800" required>
                    </div>
                    <div>
                        <label for="block-end-time" class="block text-sm font-medium text-gray-700">Đến (Giờ)</label>
                        <input type="time" id="block-end-time" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" step="1800" required>
                    </div>
                </div>
                <div>
                    <label for="block-note" class="block text-sm font-medium text-gray-700">Lý do (ví dụ: Họp, Nghỉ trưa)</label>
                    <input type="text" id="block-note" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="close-block-slot-modal" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">Huỷ</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Lưu Lịch bận</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-edit-status" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50">
      <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm">
        <h3 class="text-lg font-medium text-gray-900">Cập nhật Trạng thái</h3>
        <form id="edit-status-form" class="space-y-3 mt-2">
            <input type="hidden" id="edit-status-booking-id">
            <div>
                <label for="new-booking-status" class="block text-sm font-medium text-gray-700">Trạng thái mới</label>
                <input type="text" id="new-booking-status" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ví dụ: Đang chờ, No-show...">
            </div>
            <div class="flex justify-end space-x-2 pt-2">
                <button type="button" id="close-edit-status-modal" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50">Huỷ</button>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">Lưu</button>
            </div>
        </form>
      </div>
    </div>
    
    <div id="modal-edit-customer" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-40">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-2xl overflow-y-auto max-h-screen">
            <h3 id="customer-modal-title" class="text-xl font-bold mb-4">Thêm Khách hàng</h3>
            <form id="customer-form" class="space-y-4">
                <input type="hidden" id="customer-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">Tên khách hàng</label>
                        <input type="text" id="customer-name" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="customer-contact" class="block text-sm font-medium text-gray-700">Liên hệ (SĐT/Zalo...)</label>
                        <input type="text" id="customer-contact" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="customer-type" class="block text-sm font-medium text-gray-700">Loại khách hàng</label>
                        <select id="customer-type" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="new">Khách hàng mới</option>
                            <option value="potential">Khách tiềm năng</option>
                            <option value="priority">Khách ưu tiên</option>
                        </select>
                    </div>
                    <div>
                        <label for="customer-personality" class="block text-sm font-medium text-gray-700">Tính cách (DISC)</label>
                        <select id="customer-personality" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">(Chưa xác định)</option>
                            <option value="D">D - Quyết đoán</option>
                            <option value="I">I - Quảng giao</option>
                            <option value="S">S - Điềm đạm</option>
                            <option value="C">C - Cẩn trọng</option>
                            <option value="difficult">Khó chịu</option>
                            <option value="other">Khác (nhập ở ghi chú)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="customer-preferences" class="block text-sm font-medium text-gray-700">Sở thích</label>
                    <textarea id="customer-preferences" rows="2" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ví dụ: thích yên tĩnh, không thích gội đầu quá lâu..."></textarea>
                </div>
                <div>
                    <label for="customer-recent-services" class="block text-sm font-medium text-gray-700">Dịch vụ gần đây</label>
                    <textarea id="customer-recent-services" rows="2" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ví dụ: Uốn xoăn, Nhuộm nâu..."></textarea>
                </div>
                <div>
                    <label for="customer-notes" class="block text-sm font-medium text-gray-700">Ghi chú khách hàng</label>
                    <textarea id="customer-notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ghi chú thêm..."></textarea>
                </div>
                <div>
                    <label for="customer-userid" class="block text-sm font-medium text-gray-700">User ID (Firebase)</label>
                    <input type="text" id="customer-userid" class="mt-1 block w-full border-gray-300 rounded-lg bg-gray-100" readonly>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="close-customer-modal" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">Huỷ</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Lưu Khách hàng</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modal-edit-gallery" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-40">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg">
            <h3 id="gallery-modal-title" class="text-xl font-bold mb-4">Thêm ảnh vào Bộ sưu tập</h3>
            <form id="gallery-form" class="space-y-4">
                <input type="hidden" id="gallery-id">
                <div>
                    <label for="gallery-image-url" class="block text-sm font-medium text-gray-700">URL Hình ảnh</label>
                    <input type="text" id="gallery-image-url" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://..." required>
                </div>
                <div>
                    <label for="gallery-caption" class="block text-sm font-medium text-gray-700">Chú thích / Nội dung</label>
                    <textarea id="gallery-caption" rows="3" class="mt-1 block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nội dung mô tả..."></textarea>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="close-gallery-modal" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">Huỷ</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Lưu Ảnh</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Import các hàm Firebase cần thiết
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            getDocs, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            serverTimestamp,
            writeBatch,
            orderBy // (MỚI) Thêm orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Cấu hình Firebase (như bạn cung cấp) ---
        const firebaseConfigFromUser = {
            apiKey: "AIzaSyCTnDNOzI-8JYFfrxtJclFxe7vY27PM6FU",
            authDomain: "salon-mt.firebaseapp.com",
            projectId: "salon-mt",
            storageBucket: "salon-mt.firebasestorage.app",
            messagingSenderId: "1086041756251",
            appId: "1:1086041756251:web:5f7c4cc7144cc59be8a57e",
            measurementId: "G-3BV9HNVP29"
        };
        
        // --- Biến toàn cục từ Canvas (nếu có) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigFromUser;

        // --- Khởi tạo Firebase ---
        let app, db, auth;
        let currentAdminUser = null;
        let allBranches = []; // Cache chi nhánh
        
        // --- Hàm tiện ích ---
        
        // Lấy ngày YYYY-MM-DD
        function getTodayString(date = new Date()) {
            return date.toISOString().split('T')[0];
        }

        // Hàm Modal
        function showAlert(title, message) {
            document.getElementById('modal-alert-title').textContent = title;
            document.getElementById('modal-alert-message').textContent = message;
            document.getElementById('modal-alert').style.display = 'flex';
        }
        document.getElementById('modal-alert-close').addEventListener('click', () => {
            document.getElementById('modal-alert').style.display = 'none';
        });

        let confirmCallback = null;
        function showConfirm(title, message, callback) {
            document.getElementById('modal-confirm-title').textContent = title;
            document.getElementById('modal-confirm-message').textContent = message;
            document.getElementById('modal-confirm').style.display = 'flex';
            confirmCallback = callback;
        }
        document.getElementById('modal-confirm-cancel').addEventListener('click', () => {
            document.getElementById('modal-confirm').style.display = 'none';
            confirmCallback = null;
        });
        document.getElementById('modal-confirm-ok').addEventListener('click', () => {
            document.getElementById('modal-confirm').style.display = 'none';
            if (confirmCallback) {
                confirmCallback();
            }
            confirmCallback = null;
        });

        // Hàm chuyển trang admin
        function showAdminPage(pageId) {
            document.querySelectorAll('.admin-page-content').forEach(page => {
                page.classList.add('hidden');
            });
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
            }
            
            // Cập nhật tiêu đề (mobile)
            let title = "Quản lý";
            
            // Cập nhật trạng thái active cho nav (DÙNG CLASS 'active' MỚI)
            document.querySelectorAll('.admin-nav-button').forEach(button => {
                if (button.dataset.page === pageId) {
                    button.classList.add('active');
                    title = button.textContent.trim();
                } else {
                    button.classList.remove('active');
                }
            });
            
            document.getElementById('admin-page-title').textContent = title;
            
            // Tải dữ liệu tương ứng
            switch(pageId) {
                case 'page-dashboard': // (MỚI)
                    loadDashboardStats();
                    break;
                case 'page-bookings':
                    loadNewBookings(); // (MỚI) Tải lịch hẹn mới
                    loadBookings(); // Tải lịch hẹn theo bộ lọc
                    break;
                case 'page-technicians':
                    loadTechnicians();
                    break;
                case 'page-branches':
                    loadBranches();
                    break;
                case 'page-news':
                    loadNews();
                    break;
                case 'page-gallery':
                    loadGallery();
                    break;
                case 'page-reviews':
                    loadReviews();
                    break;
                case 'page-crm':
                    loadCrm();
                    break;
            }
        }
        
        // Toggle sidebar (mobile)
        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        }

        // Tải cache chi nhánh (dùng cho nhiều nơi)
        async function cacheBranches() {
            allBranches = [];
            try {
                const branchCollection = collection(db, `artifacts/${appId}/public/data/branches`);
                const snapshot = await getDocs(branchCollection);
                snapshot.forEach(doc => {
                    allBranches.push({ id: doc.id, ...doc.data() });
                });
                console.log("Đã tải " + allBranches.length + " chi nhánh.");
                
                // Cập nhật các dropdown chi nhánh
                updateBranchDropdowns();
                
            } catch (error) {
                console.error("Lỗi khi tải cache chi nhánh: ", error);
            }
        }
        
        // Cập nhật tất cả các dropdown chi nhánh
        function updateBranchDropdowns() {
            const selects = [
                document.getElementById('booking-branch-filter'),
                document.getElementById('technician-branch'),
                document.getElementById('manual-branch'),
                document.getElementById('block-branch')
            ];
            
            selects.forEach(select => {
                if (!select) return;
                // Giữ lại option đầu tiên (nếu có, vd: "Tất cả")
                const firstOption = select.options[0] ? select.options[0].outerHTML : '';
                select.innerHTML = firstOption;
                
                allBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.id;
                    option.textContent = branch.name;
                    select.appendChild(option);
                });
            });
        }
        
        // Định dạng timestamp
        function formatFbTimestamp(timestamp) {
            if (timestamp && typeof timestamp.toDate === 'function') {
                return timestamp.toDate().toLocaleString('vi-VN');
            }
            return 'Không có ngày';
        }

        // --- Logic Đăng nhập / Đăng xuất ---
        
        function initAuth() {
            auth = getAuth(app);
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Đã đăng nhập
                    currentAdminUser = user;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                    
                    // Tải dữ liệu ban đầu
                    cacheBranches();
                    
                    // (THAY ĐỔI) Đặt ngày mặc định cho bộ lọc (nếu cần)
                    const specificDateInput = document.getElementById('booking-date-filter-specific');
                    if (specificDateInput) {
                        specificDateInput.value = getTodayString();
                    }
                    
                    // (THAY ĐỔI) Hiển thị trang Tổng quan
                    showAdminPage('page-dashboard');
                    
                } else {
                    // Chưa đăng nhập
                    currentAdminUser = null;
                    document.getElementById('login-screen').remove('hidden');
                    document.getElementById('admin-dashboard').add('hidden');
                }
            });
            
            // Xử lý đăng nhập
            document.getElementById('login-button').addEventListener('click', async () => {
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;
                const errorEl = document.getElementById('login-error');
                
                try {
                    errorEl.classList.add('hidden');
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged sẽ tự động xử lý chuyển trang
                } catch (error) {
                    console.error("Lỗi đăng nhập: ", error);
                    errorEl.textContent = "Email hoặc mật khẩu không đúng.";
                    errorEl.classList.remove('hidden');
                }
            });
            
            // Xử lý đăng xuất
            document.getElementById('logout-button').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Lỗi đăng xuất: ", error);
                }
            });
        }
        
        // --- (MỚI) 0. Trang Tổng quan (Dashboard) ---
        
        async function loadDashboardStats() {
            try {
                // 1. Lịch hẹn hôm nay
                const today = getTodayString();
                const bookingsQuery = query(collection(db, `artifacts/${appId}/public/data/bookings`), where("date", "==", today));
                const bookingsSnap = await getDocs(bookingsQuery);
                document.getElementById('stat-today-bookings').textContent = bookingsSnap.size;

                // 2. Lịch hẹn chờ (ví dụ 'pending')
                const pendingQuery = query(collection(db, `artifacts/${appId}/public/data/bookings`), where("status", "==", "pending"));
                const pendingSnap = await getDocs(pendingQuery);
                document.getElementById('stat-pending-bookings').textContent = pendingSnap.size;

                // 3. Tổng nhân sự
                const techsSnap = await getDocs(collection(db, `artifacts/${appId}/public/data/technicians`));
                document.getElementById('stat-total-techs').textContent = techsSnap.size;

                // 4. Tổng đánh giá
                const reviewsSnap = await getDocs(collection(db, `artifacts/${appId}/public/data/reviews`));
                document.getElementById('stat-new-reviews').textContent = reviewsSnap.size;

            } catch (error) {
                console.error("Lỗi tải thống kê dashboard: ", error);
                document.getElementById('stat-today-bookings').textContent = 'Lỗi';
                document.getElementById('stat-pending-bookings').textContent = 'Lỗi';
                document.getElementById('stat-total-techs').textContent = 'Lỗi';
                document.getElementById('stat-new-reviews').textContent = 'Lỗi';
            }
        }
        
        // --- 1. Quản lý Lịch hẹn ---
        
        let currentBookings = []; // Cache cho tìm kiếm
        
        // (MỚI) Tải lịch hẹn chờ xác nhận
        async function loadNewBookings() {
            const listEl = document.getElementById('new-bookings-container');
            listEl.innerHTML = '<p class="text-center text-gray-500">Đang tải...</p>';
            
            try {
                const bookingsRef = collection(db, `artifacts/${appId}/public/data/bookings`);
                const q = query(bookingsRef, where("status", "==", "pending"), orderBy("createdAt", "desc"));
                
                const snapshot = await getDocs(q);
                let newBookings = [];
                snapshot.forEach(doc => {
                    newBookings.push({ id: doc.id, ...doc.data() });
                });
                
                renderBookingList(newBookings, listEl, "Chưa có lịch hẹn nào chờ xác nhận.");
                
            } catch (error) {
                console.error("Lỗi tải lịch hẹn mới: ", error);
                listEl.innerHTML = '<p class="text-center text-red-500">Lỗi khi tải lịch hẹn mới. (Cần tạo Index?)</p>';
            }
        }

        // (VIẾT LẠI) Tải lịch hẹn theo bộ lọc
        async function loadBookings() {
            const listEl = document.getElementById('booking-list-container');
            listEl.innerHTML = '<p class="text-center text-gray-500">Đang tải lịch hẹn...</p>';
            
            const branchId = document.getElementById('booking-branch-filter').value;
            const filterType = document.getElementById('booking-date-filter-select').value;
            const specificDate = document.getElementById('booking-date-filter-specific').value;
            
            try {
                const bookingsRef = collection(db, `artifacts/${appId}/public/data/bookings`);
                let queryConstraints = []; // Mảng chứa các điều kiện
                
                // 1. Lọc chi nhánh
                if (branchId !== 'all') {
                    queryConstraints.push(where("branchId", "==", branchId));
                }

                // 2. Lọc ngày
                const today = getTodayString(new Date());
                
                switch (filterType) {
                    case 'today':
                        queryConstraints.push(where("date", "==", today));
                        queryConstraints.push(orderBy("time", "asc"));
                        break;
                        
                    case 'recent': // 7 ngày tới (tính cả hôm nay)
                        const nextWeek = new Date();
                        nextWeek.setDate(nextWeek.getDate() + 7);
                        const nextWeekStr = getTodayString(nextWeek);
                        
                        queryConstraints.push(where("date", ">=", today));
                        queryConstraints.push(where("date", "<=", nextWeekStr));
                        queryConstraints.push(orderBy("date", "asc"));
                        queryConstraints.push(orderBy("time", "asc"));
                        break;
                        
                    case 'this_month':
                        const now = new Date();
                        const startOfMonth = getTodayString(new Date(now.getFullYear(), now.getMonth(), 1));
                        const endOfMonth = getTodayString(new Date(now.getFullYear(), now.getMonth() + 1, 0));
                        
                        queryConstraints.push(where("date", ">=", startOfMonth));
                        queryConstraints.push(where("date", "<=", endOfMonth));
                        queryConstraints.push(orderBy("date", "asc"));
                        queryConstraints.push(orderBy("time", "asc"));
                        break;
                        
                    case 'specific_date':
                        if (!specificDate) {
                            listEl.innerHTML = '<p class="text-center text-red-500">Vui lòng chọn ngày cụ thể.</p>';
                            return;
                        }
                        queryConstraints.push(where("date", "==", specificDate));
                        queryConstraints.push(orderBy("time", "asc"));
                        break;
                        
                    case 'all':
                        // Không thêm điều kiện ngày, nhưng thêm sắp xếp
                        queryConstraints.push(orderBy("date", "desc"));
                        queryConstraints.push(orderBy("time", "asc"));
                        break;
                }
                
                // 3. Tạo và thực thi truy vấn
                const q = query(bookingsRef, ...queryConstraints);
                
                const snapshot = await getDocs(q);
                currentBookings = [];
                snapshot.forEach(doc => {
                    currentBookings.push({ id: doc.id, ...doc.data() });
                });
                
                // Render (không cần sort thủ công nữa)
                renderBookingList(currentBookings, listEl, "Không tìm thấy lịch hẹn nào khớp với bộ lọc.");
                
            } catch (error) {
                console.error("Lỗi tải lịch hẹn: ", error);
                listEl.innerHTML = `<p class="text-center text-red-500">Lỗi khi tải lịch hẹn. (Bạn đã tạo Index trên Firestore cho truy vấn này chưa? Lỗi: ${error.message})</p>`;
            }
        }
        
        // (SỬA) renderBookingList để chấp nhận container và thông báo trống
        function renderBookingList(bookings, containerElement, emptyMessage) {
            const listEl = containerElement; // Dùng container được truyền vào
            const searchTerm = document.getElementById('booking-search').value.toLowerCase();
            
            // Lọc theo tìm kiếm (chỉ áp dụng cho container chính)
            let filteredBookings = bookings;
            if (containerElement.id === 'booking-list-container' && searchTerm) {
                 filteredBookings = bookings.filter(b => {
                    return (
                        b.clientName?.toLowerCase().includes(searchTerm) ||
                        b.contactDetail?.toLowerCase().includes(searchTerm) ||
                        b.bookingCode?.toLowerCase().includes(searchTerm)
                    );
                });
            }

            if (filteredBookings.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500">${emptyMessage}</p>`;
                return;
            }
            
            listEl.innerHTML = '';
            filteredBookings.forEach(booking => {
                const el = document.createElement('div');
                el.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100";
                
                let statusColor = "text-yellow-600";
                if (booking.status === 'confirmed') statusColor = "text-green-600";
                if (booking.status === 'cancelled') statusColor = "text-red-600";
                if (booking.status === 'completed') statusColor = "text-indigo-600"; 
                
                // (MỚI) Hiển thị ngày nếu là danh sách lọc (không phải hôm nay)
                const filterType = document.getElementById('booking-date-filter-select').value;
                const dateDisplay = (filterType !== 'today' && filterType !== 'specific_date' && containerElement.id === 'booking-list-container')
                    ? `<p class="font-bold text-indigo-600 text-lg">${booking.date}</p>`
                    : '';

                el.innerHTML = `
                    <div class="flex flex-col md:flex-row md:justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">${booking.bookingCode || 'KHÁCH LẺ'}</p>
                            <p class="text-lg font-semibold text-gray-900">${booking.clientName}</p>
                            <p class="text-sm text-gray-600"><i class="fas fa-phone mr-2"></i>${booking.contactDetail}</p>
                        </div>
                        <div class="mt-2 md:mt-0 md:text-right">
                            ${dateDisplay}
                            <p class="font-semibold text-lg">${booking.time}</p>
                            <p class="text-sm text-gray-600">${booking.branchName || 'Không rõ chi nhánh'}</p>
                            <p class="text-sm text-gray-600">Stylist: ${booking.technicianName || 'Salon sắp xếp'}</p>
                        </div>
                    </div>
                    <div class="border-t mt-3 pt-3 flex flex-wrap gap-2 items-center justify-between">
                        <span class="font-medium ${statusColor} capitalize">${booking.status || 'Chờ'}</span>
                        <div class="flex flex-wrap gap-2">
                            ${booking.status === 'pending' ? `<button data-id="${booking.id}" class="booking-action-confirm text-xs font-medium bg-green-100 text-green-700 px-3 py-1 rounded-full hover:bg-green-200">Xác nhận</button>` : ''}
                            ${booking.status === 'confirmed' ? `<button data-id="${booking.id}" class="booking-action-complete text-xs font-medium bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200">Hoàn thành</button>` : ''}
                            <button data-id="${booking.id}" class="booking-action-cancel text-xs font-medium bg-red-100 text-red-700 px-3 py-1 rounded-full hover:bg-red-200">Huỷ lịch</button>
                            <button data-id="${booking.id}" class="booking-action-other text-xs font-medium bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200">Cập nhật...</button>
                        </div>
                    </div>
                `;
                listEl.appendChild(el);
            });
            
            // Gán sự kiện cho các nút
            attachBookingActionListeners();
        }

        function attachBookingActionListeners() {
            document.querySelectorAll('.booking-action-confirm').forEach(btn => {
                btn.onclick = () => updateBookingStatus(btn.dataset.id, 'confirmed');
            });
            document.querySelectorAll('.booking-action-complete').forEach(btn => {
                btn.onclick = () => updateBookingStatus(btn.dataset.id, 'completed');
            });
            document.querySelectorAll('.booking-action-cancel').forEach(btn => {
                btn.onclick = () => updateBookingStatus(btn.dataset.id, 'cancelled');
            });
            document.querySelectorAll('.booking-action-other').forEach(btn => {
                btn.onclick = () => {
                    document.getElementById('edit-status-booking-id').value = btn.dataset.id;
                    document.getElementById('new-booking-status').value = '';
                    document.getElementById('modal-edit-status').style.display = 'flex';
                };
            });
        }
        
        async function updateBookingStatus(id, status) {
            if (!status) return;
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/bookings`, id);
                await updateDoc(docRef, { status: status });
                showAlert("Thành công", `Đã cập nhật trạng thái thành "${status}".`);
                loadNewBookings(); // Tải lại cả 2
                loadBookings(); 
            } catch (error) {
                console.error("Lỗi cập nhật trạng thái: ", error);
                showAlert("Lỗi", "Không thể cập nhật trạng thái.");
            }
        }
        
        // Form cập nhật trạng thái
        document.getElementById('edit-status-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-status-booking-id').value;
            const status = document.getElementById('new-booking-status').value;
            await updateBookingStatus(id, status);
            document.getElementById('modal-edit-status').style.display = 'none';
        });
        document.getElementById('close-edit-status-modal').addEventListener('click', () => {
            document.getElementById('modal-edit-status').style.display = 'none';
        });

        // (SỬA) Thay đổi bộ lọc
        document.getElementById('booking-branch-filter').addEventListener('change', loadBookings);
        
        // (MỚI) Bộ lọc ngày
        document.getElementById('booking-date-filter-select').addEventListener('change', (e) => {
            const specificDateInput = document.getElementById('booking-date-filter-specific');
            if (e.target.value === 'specific_date') {
                specificDateInput.classList.remove('hidden');
                // Đặt ngày mặc định nếu chưa có
                if (!specificDateInput.value) {
                    specificDateInput.value = getTodayString();
                }
            } else {
                specificDateInput.classList.add('hidden');
            }
            loadBookings();
        });
        // (MỚI) Thay đổi ngày cụ thể
        document.getElementById('booking-date-filter-specific').addEventListener('change', loadBookings);

        document.getElementById('booking-search').addEventListener('input', () => {
            // Lọc trên dữ liệu đã tải (chỉ lọc danh sách chính)
            renderBookingList(currentBookings, document.getElementById('booking-list-container'), "Không tìm thấy lịch hẹn nào khớp với bộ lọc."); 
        });
        
        // Lưu số ghế tạm
        document.getElementById('save-temp-seats').addEventListener('click', async () => {
            const branchId = document.getElementById('booking-branch-filter').value;
            const filterType = document.getElementById('booking-date-filter-select').value;
            const date = document.getElementById('booking-date-filter-specific').value;
            const usedSeats = parseInt(document.getElementById('temp-used-seats').value) || 0;
            
            if (branchId === 'all') {
                showAlert("Thông báo", "Vui lòng chọn một chi nhánh cụ thể.");
                return;
            }
            if (filterType !== 'specific_date' && filterType !== 'today') {
                 showAlert("Thông báo", "Chỉ có thể đặt số ghế tạm cho 'Hôm nay' hoặc 'Ngày cụ thể'.");
                return;
            }
            
            const targetDate = (filterType === 'today') ? getTodayString() : date;
            
            try {
                const branchRef = doc(db, `artifacts/${appId}/public/data/branches`, branchId);
                
                // Dùng dot notation để cập nhật nested object
                const updateData = {};
                updateData[`dailyOverrides.${targetDate}.tempUsedSeats`] = usedSeats;
                
                await updateDoc(branchRef, updateData);
                
                const statusEl = document.getElementById('temp-seats-status');
                statusEl.textContent = `Đã lưu! ${usedSeats} ghế đang dùng cho ngày ${targetDate}.`;
                statusEl.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('hidden'), 3000);
                
            } catch (error) {
                console.error("Lỗi lưu số ghế tạm: ", error);
                showAlert("Lỗi", "Không thể lưu. (Lỗi: " + error.message + ")");
            }
        });
        
        // Thêm lịch hẹn thủ công
        document.getElementById('open-manual-booking-modal').addEventListener('click', async () => {
            document.getElementById('manual-booking-form').reset();
            // Tải kỹ thuật viên cho chi nhánh đang chọn
            const branchId = document.getElementById('manual-branch').value;
            await loadTechniciansForDropdown(branchId, 'manual-technician');
            
            document.getElementById('modal-manual-booking').style.display = 'flex';
        });
        
        // Thay đổi chi nhánh -> tải lại KTV
        document.getElementById('manual-branch').addEventListener('change', (e) => {
            loadTechniciansForDropdown(e.target.value, 'manual-technician');
        });

        async function loadTechniciansForDropdown(branchId, selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="any">Để salon sắp xếp</option>';
            if (!branchId) return;
            
            try {
                 const q = query(
                    collection(db, `artifacts/${appId}/public/data/technicians`),
                    where("branchId", "==", branchId)
                );
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => {
                    const tech = doc.data();
                    select.innerHTML += `<option value="${doc.id}" data-name="${tech.name}">${tech.name}</option>`;
                });
            } catch (e) { console.error(e); }
        }
        
        // Đóng modal
        document.getElementById('close-manual-booking-modal').addEventListener('click', () => {
            document.getElementById('modal-manual-booking').style.display = 'none';
        });

        // Submit lịch hẹn thủ công
        document.getElementById('manual-booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const branchSelect = document.getElementById('manual-branch');
            const techSelect = document.getElementById('manual-technician');
            
            const bookingData = {
                branchId: branchSelect.value,
                branchName: branchSelect.options[branchSelect.selectedIndex].text,
                date: document.getElementById('manual-date').value,
                time: document.getElementById('manual-time').value,
                technicianId: techSelect.value,
                technicianName: techSelect.value === 'any' ? 'Salon sắp xếp' : techSelect.options[techSelect.selectedIndex].dataset.name,
                clientName: document.getElementById('manual-client-name').value,
                contactDetail: document.getElementById('manual-client-contact').value,
                status: 'confirmed',
                source: 'admin_manual', // Đánh dấu là admin tạo
                createdAt: serverTimestamp()
            };
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/bookings`), bookingData);
                showAlert("Thành công", "Đã thêm lịch hẹn thủ công.");
                document.getElementById('modal-manual-booking').style.display = 'none';
                loadBookings(); // Tải lại
            } catch (error) {
                console.error("Lỗi thêm lịch hẹn: ", error);
                showAlert("Lỗi", "Không thể thêm lịch hẹn.");
            }
        });
        
        // Thêm lịch bận
        document.getElementById('open-block-slot-modal').addEventListener('click', () => {
            document.getElementById('block-slot-form').reset();
            document.getElementById('block-date').value = getTodayString();
            document.getElementById('modal-block-slot').style.display = 'flex';
        });
        document.getElementById('close-block-slot-modal').addEventListener('click', () => {
            document.getElementById('modal-block-slot').style.display = 'none';
        });
        document.getElementById('block-slot-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const branchId = document.getElementById('block-branch').value;
            const date = document.getElementById('block-date').value;
            const startTime = document.getElementById('block-start-time').value;
            const endTime = document.getElementById('block-end-time').value;

            if (endTime <= startTime) {
                showAlert("Lỗi", "Giờ kết thúc phải sau giờ bắt đầu.");
                return;
            }
            
            const blockData = {
                branchId: branchId,
                date: date,
                startTime: startTime,
                endTime: endTime,
                note: document.getElementById('block-note').value,
                createdAt: serverTimestamp()
            };
            
            try {
                // (Lưu ý: Cần cập nhật index.html để đọc collection này)
                await addDoc(collection(db, `artifacts/${appId}/public/data/blocked_slots`), blockData);
                showAlert("Thành công", "Đã thêm lịch bận.");
                document.getElementById('modal-block-slot').style.display = 'none';
            } catch (error) {
                console.error("Lỗi thêm lịch bận: ", error);
                showAlert("Lỗi", "Không thể thêm lịch bận.");
            }
        });

        // --- 2. Quản lý Nhân sự ---
        
        async function loadTechnicians() {
            const listEl = document.getElementById('technician-list-container');
            listEl.innerHTML = '<p class="text-center text-gray-500 p-4">Đang tải nhân sự...</p>';
            
            try {
                const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/technicians`));
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-center text-gray-500 p-4">Chưa có nhân sự nào.</p>';
                    return;
                }
                
                let html = `
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b bg-slate-50 text-sm font-semibold text-gray-600">
                                <th class="p-3">Nhân sự</th>
                                <th class="p-3 hidden md:table-cell">Chức vụ</th>
                                <th class="p-3">Chi nhánh (Sắp xếp nhanh)</th>
                                <th class="p-3">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Tạo branch options
                let branchOptions = allBranches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
                
                snapshot.forEach(doc => {
                    const tech = doc.data();
                    const photo = tech.photoUrl || `https://placehold.co/40x40/E2E8F0/64748B?text=${tech.name[0]}`;
                    html += `
                        <tr class="border-b">
                            <td class="p-3">
                                <div class="flex items-center space-x-3">
                                    <img src="${photo}" class="w-10 h-10 rounded-full object-cover">
                                    <div>
                                        <p class="font-medium">${tech.name}</p>
                                        <p class="text-sm text-gray-500 md:hidden">${tech.title || 'Chưa có'}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="p-3 hidden md:table-cell">${tech.title || 'Chưa có'} (${tech.experience || 0} năm)</td>
                            <td class="p-3">
                                <select data-id="${doc.id}" class="quick-branch-assign mt-1 block w-full border-gray-300 rounded-lg shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    ${branchOptions}
                                </select>
                            </td>
                            <td class="p-3 space-x-2">
                                <button data-id="${doc.id}" class="edit-technician-btn text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-technician-btn text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                listEl.innerHTML = html;
                
                // Gán giá trị
                document.querySelectorAll('.quick-branch-assign').forEach(select => {
                    const techId = select.dataset.id;
                    const tech = snapshot.docs.find(d => d.id === techId).data();
                    if(tech.branchId) {
                        select.value = tech.branchId;
                    }
                    // Gán sự kiện
                    select.addEventListener('change', (e) => quickAssignBranch(techId, e.target.value));
                });
                
                // Gán sự kiện
                document.querySelectorAll('.edit-technician-btn').forEach(btn => btn.addEventListener('click', () => openTechnicianModal(btn.dataset.id)));
                document.querySelectorAll('.delete-technician-btn').forEach(btn => btn.addEventListener('click', () => deleteTechnician(btn.dataset.id)));
                
            } catch (error) {
                console.error("Lỗi tải nhân sự: ", error);
                listEl.innerHTML = '<p class="text-center text-red-500 p-4">Lỗi khi tải nhân sự.</p>';
            }
        }
        
        async function quickAssignBranch(techId, branchId) {
            const branch = allBranches.find(b => b.id === branchId);
            if (!branch) return;
            
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/technicians`, techId);
                await updateDoc(docRef, {
                    branchId: branch.id,
                    branchName: branch.name // Lưu tên để dễ truy vấn
                });
                showAlert("Thành công", "Đã cập nhật chi nhánh cho nhân sự.");
            } catch (error) {
                console.error("Lỗi cập nhật chi nhánh: ", error);
                showAlert("Lỗi", "Không thể cập nhật.");
            }
        }
        
        // Mở Modal (Thêm)
        document.getElementById('open-technician-modal').addEventListener('click', () => openTechnicianModal(null));
        // Đóng Modal
        document.getElementById('close-technician-modal').addEventListener('click', () => {
            document.getElementById('modal-edit-technician').style.display = 'none';
        });
        
        async function openTechnicianModal(id) {
            const form = document.getElementById('technician-form');
            form.reset();
            document.getElementById('technician-branch').innerHTML = allBranches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            
            if (id) {
                // Sửa
                document.getElementById('technician-modal-title').textContent = "Sửa Nhân sự";
                document.getElementById('technician-id').value = id;
                
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/technicians`, id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('technician-name').value = data.name;
                        document.getElementById('technician-title').value = data.title;
                        document.getElementById('technician-experience').value = data.experience;
                        document.getElementById('technician-photourl').value = data.photoUrl;
                        document.getElementById('technician-branch').value = data.branchId;
                    }
                } catch (error) { console.error(error); }
                
            } else {
                // Thêm
                document.getElementById('technician-modal-title').textContent = "Thêm Nhân sự";
                document.getElementById('technician-id').value = '';
            }
            document.getElementById('modal-edit-technician').style.display = 'flex';
        }
        
        // Lưu
        document.getElementById('technician-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('technician-id').value;
            const branchId = document.getElementById('technician-branch').value;
            const branch = allBranches.find(b => b.id === branchId);
            
            const data = {
                name: document.getElementById('technician-name').value,
                title: document.getElementById('technician-title').value,
                experience: document.getElementById('technician-experience').value,
                photoUrl: document.getElementById('technician-photourl').value,
                branchId: branchId,
                branchName: branch ? branch.name : ""
            };
            
            try {
                if (id) {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/technicians`, id), data);
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/technicians`), data);
                }
                document.getElementById('modal-edit-technician').style.display = 'none';
                showAlert("Thành công", "Đã lưu nhân sự.");
                loadTechnicians();
            } catch (error) {
                console.error("Lỗi lưu nhân sự: ", error);
                showAlert("Lỗi", "Không thể lưu.");
            }
        });
        
        // Xoá
        async function deleteTechnician(id) {
            showConfirm("Xác nhận xoá", "Bạn có chắc muốn xoá nhân sự này? (Không thể hoàn tác)", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/technicians`, id));
                    showAlert("Thành công", "Đã xoá nhân sự.");
                    loadTechnicians();
                } catch (error) {
                    console.error("Lỗi xoá nhân sự: ", error);
                    showAlert("Lỗi", "Không thể xoá.");
                }
            });
        }
        
        // --- 3. Quản lý Chi nhánh ---
        
        async function loadBranches() {
            const listEl = document.getElementById('branch-list-container');
            listEl.innerHTML = '<p class="text-center text-gray-500 p-4">Đang tải chi nhánh...</p>';
            
            try {
                const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/branches`));
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-center text-gray-500 p-4">Chưa có chi nhánh nào.</p>';
                    return;
                }
                
                let html = `
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b bg-slate-50 text-sm font-semibold text-gray-600">
                                <th class="p-3">Chi nhánh</th>
                                <th class="p-3 hidden md:table-cell">Giờ làm việc</th>
                                <th class="p-3">Ghế</th>
                                <th class="p-3">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                snapshot.forEach(doc => {
                    const branch = doc.data();
                    html += `
                        <tr class="border-b">
                            <td class="p-3">
                                <p class="font-medium">${branch.name}</p>
                                <p class="text-sm text-gray-500">${branch.address}</p>
                            </td>
                            <td class="p-3 hidden md:table-cell">${branch.openingTime} - ${branch.closingTime}</td>
                            <td class="p-3">${branch.totalSeats || 0}</td>
                            <td class="p-3 space-x-2">
                                <button data-id="${doc.id}" class="edit-branch-btn text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-branch-btn text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                listEl.innerHTML = html;
                
                // Gán sự kiện
                document.querySelectorAll('.edit-branch-btn').forEach(btn => btn.addEventListener('click', () => openBranchModal(btn.dataset.id)));
                document.querySelectorAll('.delete-branch-btn').forEach(btn => btn.addEventListener('click', () => deleteBranch(btn.dataset.id)));
                
            } catch (error) {
                console.error("Lỗi tải chi nhánh: ", error);
                listEl.innerHTML = '<p class="text-center text-red-500 p-4">Lỗi khi tải chi nhánh.</p>';
            }
        }
        
        // Mở Modal (Thêm)
        document.getElementById('open-branch-modal').addEventListener('click', () => openBranchModal(null));
        // Đóng Modal
        document.getElementById('close-branch-modal').addEventListener('click', () => {
            document.getElementById('modal-edit-branch').style.display = 'none';
        });

        async function openBranchModal(id) {
            const form = document.getElementById('branch-form');
            form.reset();
            if (id) {
                // Sửa
                document.getElementById('branch-modal-title').textContent = "Sửa Chi nhánh";
                document.getElementById('branch-id').value = id;
                
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/branches`, id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('branch-name').value = data.name;
                        document.getElementById('branch-address').value = data.address;
                        document.getElementById('branch-phone').value = data.phone;
                        document.getElementById('branch-opening-time').value = data.openingTime;
                        document.getElementById('branch-closing-time').value = data.closingTime;
                        document.getElementById('branch-total-seats').value = data.totalSeats;
                    }
                } catch (error) { console.error(error); }
                
            } else {
                // Thêm
                document.getElementById('branch-modal-title').textContent = "Thêm Chi nhánh";
                document.getElementById('branch-id').value = '';
            }
            document.getElementById('modal-edit-branch').style.display = 'flex';
        }

        // Lưu
        document.getElementById('branch-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('branch-id').value;
            const data = {
                name: document.getElementById('branch-name').value,
                address: document.getElementById('branch-address').value,
                phone: document.getElementById('branch-phone').value,
                openingTime: document.getElementById('branch-opening-time').value,
                closingTime: document.getElementById('branch-closing-time').value,
                totalSeats: parseInt(document.getElementById('branch-total-seats').value),
            };
            
            try {
                if (id) {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/branches`, id), data, { merge: true });
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/branches`), data);
                }
                document.getElementById('modal-edit-branch').style.display = 'none';
                showAlert("Thành công", "Đã lưu chi nhánh.");
                cacheBranches(); // Cập nhật cache
                loadBranches();
            } catch (error) {
                console.error("Lỗi lưu chi nhánh: ", error);
                showAlert("Lỗi", "Không thể lưu.");
            }
        });
        
        // Xoá
        async function deleteBranch(id) {
            showConfirm("Xác nhận xoá", "Bạn có chắc muốn xoá chi nhánh này? (Không thể hoàn tác)", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/branches`, id));
                    showAlert("Thành công", "Đã xoá chi nhánh.");
                    cacheBranches(); // Cập nhật cache
                    loadBranches();
                } catch (error) {
                    console.error("Lỗi xoá chi nhánh: ", error);
                    showAlert("Lỗi", "Không thể xoá.");
                }
            });
        }
        
        // Mở modal lịch nghỉ
        document.getElementById('open-special-schedule-modal').addEventListener('click', () => {
            const branchId = document.getElementById('branch-id').value;
            if (!branchId) {
                showAlert("Thông báo", "Vui lòng lưu chi nhánh trước khi thêm lịch nghỉ.");
                return;
            }
            document.getElementById('special-schedule-branch-id').value = branchId;
            document.getElementById('special-schedule-form').reset();
            document.getElementById('schedule-start-date').value = getTodayString();
            document.getElementById('modal-special-schedule').style.display = 'flex';
        });
        document.getElementById('close-special-schedule-modal').addEventListener('click', () => {
            document.getElementById('modal-special-schedule').style.display = 'none';
        });

        // Lưu lịch nghỉ
        document.getElementById('special-schedule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const branchId = document.getElementById('special-schedule-branch-id').value;
            const startDateStr = document.getElementById('schedule-start-date').value;
            const numDays = parseInt(document.getElementById('schedule-num-days').value);
            const note = document.getElementById('schedule-note').value;
            
            if (!branchId || !startDateStr || numDays < 1) {
                showAlert("Lỗi", "Vui lòng nhập đầy đủ thông tin.");
                return;
            }
            
            try {
                const branchRef = doc(db, `artifacts/${appId}/public/data/branches`, branchId);
                const branchSnap = await getDoc(branchRef);
                const branchData = branchSnap.data();
                
                let schedule = branchData.specialSchedule || {};
                
                const startDate = new Date(startDateStr + "T00:00:00"); // Đảm bảo đúng múi giờ
                
                for (let i = 0; i < numDays; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    const dateKey = getTodayString(date);
                    schedule[dateKey] = {
                        status: "closed",
                        note: note
                    };
                }
                
                await updateDoc(branchRef, { specialSchedule: schedule });
                
                showAlert("Thành công", `Đã thiết lập lịch nghỉ ${numDays} ngày.`);
                document.getElementById('modal-special-schedule').style.display = 'none';
                
            } catch (error) {
                console.error("Lỗi lưu lịch nghỉ: ", error);
                showAlert("Lỗi", "Không thể lưu lịch nghỉ.");
            }
        });
        
        // --- 4. Quản lý Tin tức ---
        
        async function loadNews() {
            const listEl = document.getElementById('news-list-container');
            listEl.innerHTML = '<p class="text-center text-gray-500">Đang tải bài viết...</p>';
            
            try {
                const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/news`));
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-center text-gray-500">Chưa có bài viết nào.</p>';
                    return;
                }
                
                let html = `<div class="space-y-3">`;
                let items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                
                // Sắp xếp
                items.sort((a, b) => (b.createdAt && a.createdAt) ? b.createdAt.toDate() - a.createdAt.toDate() : 0);
                
                items.forEach(item => {
                    const typeLabel = item.type === 'offer' 
                        ? '<span class="text-xs font-medium text-green-600 bg-green-100 px-2 py-0.5 rounded-full">Ưu đãi</span>'
                        : '<span class="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">Tin tức</span>';
                    
                    html += `
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-lg">${item.title}</h4>
                                    <p class="text-sm text-gray-500">${formatFbTimestamp(item.createdAt)} ${typeLabel}</p>
                                </div>
                                <div class="space-x-2 flex-shrink-0 ml-2">
                                    <button data-id="${item.id}" class="edit-news-btn text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button>
                                    <button data-id="${item.id}" class="delete-news-btn text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-700 mt-2 prose prose-sm">${item.content}</div>
                        </div>
                    `;
                    // Dùng class 'prose' để render HTML (nếu có)
                });
                
                html += '</div>';
                listEl.innerHTML = html;
                
                // Gán sự kiện
                document.querySelectorAll('.edit-news-btn').forEach(btn => btn.addEventListener('click', () => openNewsModal(btn.dataset.id)));
                document.querySelectorAll('.delete-news-btn').forEach(btn => btn.addEventListener('click', () => deleteNews(btn.dataset.id)));
                
            } catch (error) {
                console.error("Lỗi tải tin tức: ", error);
                listEl.innerHTML = '<p class="text-center text-red-500">Lỗi khi tải tin tức.</p>';
            }
        }
        
        // Mở Modal
        document.getElementById('open-news-modal').addEventListener('click', () => openNewsModal(null));
        document.getElementById('close-news-modal').addEventListener('click', () => {
            document.getElementById('modal-edit-news').style.display = 'none';
        });

        // Chuyển chế độ Text/HTML
        document.querySelectorAll('.news-content-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.dataset.contentType;
                document.querySelectorAll('.news-content-type-btn').forEach(b => {
                    b.classList.remove('bg-indigo-600', 'text-white');
                    b.classList.add('bg-gray-200', 'text-gray-800');
                });
                btn.classList.add('bg-indigo-600', 'text-white');
                btn.classList.remove('bg-gray-200', 'text-gray-800');
                
                if (type === 'html') {
                    document.getElementById('news-content-text').classList.add('hidden');
                    document.getElementById('news-content-html').classList.remove('hidden');
                    document.getElementById('news-content-mode').value = 'html';
                } else {
                    document.getElementById('news-content-text').classList.remove('hidden');
                    document.getElementById('news-content-html').add('hidden');
                    document.getElementById('news-content-mode').value = 'text';
                }
            });
        });
        
        async function openNewsModal(id) {
            const form = document.getElementById('news-form');
            form.reset();
            // Reset content tabs
            document.querySelector('.news-content-type-btn[data-content-type="text"]').click();
            
            if (id) {
                // Sửa
                document.getElementById('news-modal-title').textContent = "Sửa Bài viết";
                document.getElementById('news-id').value = id;
                
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/news`, id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('news-title').value = data.title;
                        document.getElementById('news-type').value = data.type;
                        
                        // Giả sử nội dung luôn lưu ở 'content'
                        // (Nếu lưu 2 trường text/html riêng, logic sẽ khác)
                        document.getElementById('news-content-text').value = data.content;
                        document.getElementById('news-content-html').value = data.content; 
                    }
                } catch (error) { console.error(error); }
                
            } else {
                // Thêm
                document.getElementById('news-modal-title').textContent = "Thêm Bài viết / Ưu đãi";
                document.getElementById('news-id').value = '';
            }
            document.getElementById('modal-edit-news').style.display = 'flex';
        }
        
        // Lưu
        document.getElementById('news-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('news-id').value;
            const contentMode = document.getElementById('news-content-mode').value;
            const content = (contentMode === 'html')
                ? document.getElementById('news-content-html').value
                : document.getElementById('news-content-text').value;

            const data = {
                title: document.getElementById('news-title').value,
                type: document.getElementById('news-type').value,
                content: content,
                createdAt: serverTimestamp()
            };
            
            try {
                if (id) {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/news`, id), data, { merge: true }); // merge để giữ createdAt nếu k muốn cập nhật
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/news`), data);
                }
                document.getElementById('modal-edit-news').style.display = 'none';
                showAlert("Thành công", "Đã lưu bài viết.");
                loadNews();
            } catch (error) {
                console.error("Lỗi lưu bài viết: ", error);
                showAlert("Lỗi", "Không thể lưu.");
            }
        });
        
        async function deleteNews(id) {
            showConfirm("Xác nhận xoá", "Bạn có chắc muốn xoá bài viết này? (Không thể hoàn tác)", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/news`, id));
                    showAlert("Thành công", "Đã xoá bài viết.");
                    loadNews();
                } catch (error) {
                    console.error("Lỗi xoá bài viết: ", error);
                    showAlert("Lỗi", "Không thể xoá.");
                }
            });
        }
        
        // --- 5. Quản lý Bộ sưu tập ---
        
        async function loadGallery() {
            const listEl = document.getElementById('gallery-list-container');
            listEl.innerHTML = '<p class="text-center text-gray-500 col-span-full">Đang tải bộ sưu tập...</p>';
            
             try {
                const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/gallery`));
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-center text-gray-500 col-span-full">Chưa có ảnh nào trong bộ sưu tập.</p>';
                    return;
                }
                
                let html = ``;
                let items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                
                // Sắp xếp
                items.sort((a, b) => (b.createdAt && a.createdAt) ? b.createdAt.toDate() - a.createdAt.toDate() : 0);
                
                items.forEach(item => {
                    html += `
                        <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden">
                            <img src="${item.imageUrl}" alt="${item.caption || 'Ảnh gallery'}" class="w-full h-48 object-cover">
                            <div class="p-3">
                                <p class="text-sm text-gray-700 h-10 overflow-y-auto">${item.caption || 'Không có chú thích'}</p>
                                <button data-id="${item.id}" class="delete-gallery-btn text-xs text-red-600 hover:underline mt-2">
                                    <i class="fas fa-trash mr-1"></i> Xoá
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                listEl.innerHTML = html;
                
                // Gán sự kiện
                document.querySelectorAll('.delete-gallery-btn').forEach(btn => btn.addEventListener('click', () => deleteGalleryItem(btn.dataset.id)));
                
            } catch (error) {
                console.error("Lỗi tải gallery: ", error);
                listEl.innerHTML = '<p class="text-center text-red-500 col-span-full">Lỗi khi tải bộ sưu tập.</p>';
            }
        }
        
        // Mở Modal
        document.getElementById('open-gallery-modal').addEventListener('click', () => openGalleryModal(null));
        document.getElementById('close-gallery-modal').addEventListener('click', () => {
            document.getElementById('modal-edit-gallery').style.display = 'none';
        });

        function openGalleryModal(id) {
            // Hiện tại chỉ hỗ trợ thêm mới, không sửa
            const form = document.getElementById('gallery-form');
            form.reset();
            document.getElementById('gallery-id').value = '';
            document.getElementById('gallery-modal-title').textContent = "Thêm ảnh vào Bộ sưu tập";
            document.getElementById('modal-edit-gallery').style.display = 'flex';
        }
        
        // Lưu
        document.getElementById('gallery-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('gallery-id').value;
            const data = {
                imageUrl: document.getElementById('gallery-image-url').value,
                caption: document.getElementById('gallery-caption').value,
                createdAt: serverTimestamp()
            };
            
            try {
                // Hiện tại chỉ hỗ trợ thêm mới
                await addDoc(collection(db, `artifacts/${appId}/public/data/gallery`), data);
                
                document.getElementById('modal-edit-gallery').style.display = 'none';
                showAlert("Thành công", "Đã thêm ảnh.");
                loadGallery();
            } catch (error) {
                console.error("Lỗi lưu ảnh: ", error);
                showAlert("Lỗi", "Không thể lưu.");
            }
        });
        
        // Xoá
        async function deleteGalleryItem(id) {
            showConfirm("Xác nhận xoá", "Bạn có chắc muốn xoá ảnh này? (Không thể hoàn tác)", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/gallery`, id));
                    showAlert("Thành công", "Đã xoá ảnh.");
                    loadGallery();
                } catch (error) {
                    console.error("Lỗi xoá ảnh: ", error);
                    showAlert("Lỗi", "Không thể xoá.");
                }
            });
        }
        
        // --- 6. Quản lý Đánh giá ---
        
        async function loadReviews() {
             const listEl = document.getElementById('review-list-container');
            listEl.innerHTML = '<p class="text-center text-gray-500">Đang tải đánh giá...</p>';
            
             try {
                const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/reviews`));
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-center text-gray-500">Chưa có đánh giá nào.</p>';
                    return;
                }
                
                let html = `<div class="space-y-3">`;
                let items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                
                // Sắp xếp
                items.sort((a, b) => (b.createdAt && a.createdAt) ? b.createdAt.toDate() - a.createdAt.toDate() : 0);
                
                items.forEach(item => {
                    html += `
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold">${item.anonymous ? 'Khách ẩn danh' : item.clientName}</h4>
                                    <p class="text-sm text-gray-500">${formatFbTimestamp(item.createdAt)}</p>
                                </div>
                                <div class="text-right text-yellow-500">
                                    <p>DV: ${'★'.repeat(item.serviceRating)}${'☆'.repeat(5 - item.serviceRating)}</p>
                                    <p>TĐ: ${'★'.repeat(item.attitudeRating)}${'☆'.repeat(5 - item.attitudeRating)}</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-700 mt-2"><b>Cảm nhận:</b> ${item.feedback || 'Không có'}</p>
                            ${item.serviceDetail ? `<p class="text-sm text-orange-600 mt-1"><b>Chi tiết Dịch vụ:</b> ${item.serviceDetail}</p>` : ''}
                            ${item.attitudeDetail ? `<p class="text-sm text-orange-600 mt-1"><b>Chi tiết Thái độ:</b> ${item.attitudeDetail}</p>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                listEl.innerHTML = html;
                
            } catch (error) {
                console.error("Lỗi tải đánh giá: ", error);
                listEl.innerHTML = '<p class="text-center text-red-500">Lỗi khi tải đánh giá.</p>';
            }
        }
        
        // --- 7. Quản lý Khách hàng (CRM) ---
        
        async function loadCrm() {
            const listEl = document.getElementById('customer-list-container');
            listEl.innerHTML = '<p class="text-center text-gray-500 p-4">Đang tải khách hàng...</p>';
            
             try {
                const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/customers`));
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-center text-gray-500 p-4">Chưa có dữ liệu khách hàng. Hãy thử "Đồng bộ từ Lịch hẹn".</p>';
                    return;
                }
                
                let html = `
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b bg-slate-50 text-sm font-semibold text-gray-600">
                                <th class="p-3">Khách hàng</th>
                                <th class="p-3 hidden md:table-cell">Loại</th>
                                <th class="p-3 hidden md:table-cell">Tính cách</th>
                                <th class="p-3 hidden md:table-cell">Dịch vụ gần đây</th>
                                <th class="p-3 hidden md:table-cell">Ghi chú</th>
                                <th class="p-3">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                snapshot.forEach(doc => {
                    const c = doc.data();
                    html += `
                        <tr class="border-b">
                            <td class="p-3">
                                <p class="font-medium">${c.name || 'N/A'}</p>
                                <p class="text-sm text-gray-500">${c.contact || 'N/A'}</p>
                            </td>
                            <td class="p-3 hidden md:table-cell capitalize">${c.type || 'new'}</td>
                            <td class="p-3 hidden md:table-cell capitalize">${c.personality || 'N/A'}</td>
                            <td class="p-3 hidden md:table-cell text-sm text-gray-600 truncate" style="max-width: 200px;">${c.recentServices || 'N/A'}</td>
                            <td class="p-3 hidden md:table-cell text-sm text-gray-600 truncate" style="max-width: 200px;">${c.notes || 'N/A'}</td>
                            <td class="p-3 space-x-2">
                                <button data-id="${doc.id}" class="edit-customer-btn text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button>
                                <button data-id="${doc.id}" class="delete-customer-btn text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                listEl.innerHTML = html;
                
                // Gán sự kiện
                document.querySelectorAll('.edit-customer-btn').forEach(btn => btn.addEventListener('click', () => openCustomerModal(btn.dataset.id)));
                document.querySelectorAll('.delete-customer-btn').forEach(btn => btn.addEventListener('click', () => deleteCustomer(btn.dataset.id)));
                
            } catch (error) {
                console.error("Lỗi tải CRM: ", error);
                listEl.innerHTML = '<p class="text-center text-red-500 p-4">Lỗi khi tải CRM.</p>';
            }
        }
        
        // Mở Modal (Thêm)
        document.getElementById('open-customer-modal').addEventListener('click', () => openCustomerModal(null));
        // Đóng Modal
        document.getElementById('close-customer-modal').addEventListener('click', () => {
            document.getElementById('modal-edit-customer').style.display = 'none';
        });
        
        async function openCustomerModal(id) {
            const form = document.getElementById('customer-form');
            form.reset();
            if (id) {
                // Sửa
                document.getElementById('customer-modal-title').textContent = "Sửa Khách hàng";
                document.getElementById('customer-id').value = id;
                
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/customers`, id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('customer-name').value = data.name;
                        document.getElementById('customer-contact').value = data.contact;
                        document.getElementById('customer-type').value = data.type;
                        document.getElementById('customer-personality').value = data.personality;
                        document.getElementById('customer-preferences').value = data.preferences;
                        document.getElementById('customer-recent-services').value = data.recentServices;
                        document.getElementById('customer-notes').value = data.notes;
                        document.getElementById('customer-userid').value = data.userId;
                    }
                } catch (error) { console.error(error); }
                
            } else {
                // Thêm
                document.getElementById('customer-modal-title').textContent = "Thêm Khách hàng";
                document.getElementById('customer-id').value = '';
            }
            document.getElementById('modal-edit-customer').style.display = 'flex';
        }
        
        // Lưu
        document.getElementById('customer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('customer-id').value;
            const data = {
                name: document.getElementById('customer-name').value,
                contact: document.getElementById('customer-contact').value,
                type: document.getElementById('customer-type').value,
                personality: document.getElementById('customer-personality').value,
                preferences: document.getElementById('customer-preferences').value,
                recentServices: document.getElementById('customer-recent-services').value,
                notes: document.getElementById('customer-notes').value,
                userId: document.getElementById('customer-userid').value, // Giữ nguyên nếu có
            };
            
            try {
                const collectionRef = collection(db, `artifacts/${appId}/public/data/customers`);
                if (id) {
                    await setDoc(doc(collectionRef, id), data, { merge: true });
                } else {
                    await addDoc(collectionRef, data);
                }
                document.getElementById('modal-edit-customer').style.display = 'none';
                showAlert("Thành công", "Đã lưu khách hàng.");
                loadCrm();
            } catch (error) {
                console.error("Lỗi lưu khách hàng: ", error);
                showAlert("Lỗi", "Không thể lưu.");
            }
        });
        
        // Xoá
        async function deleteCustomer(id) {
            showConfirm("Xác nhận xoá", "Bạn có chắc muốn xoá khách hàng này? (Không thể hoàn tác)", async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/customers`, id));
                    showAlert("Thành công", "Đã xoá khách hàng.");
                    loadCrm();
                } catch (error) {
                    console.error("Lỗi xoá khách hàng: ", error);
                    showAlert("Lỗi", "Không thể xoá.");
                }
            });
        }
        
        // Đồng bộ
        document.getElementById('sync-customers').addEventListener('click', async () => {
            showConfirm("Xác nhận", "Đồng bộ sẽ tạo/cập nhật hồ sơ khách hàng từ lịch hẹn. Tiếp tục?", async () => {
                try {
                    const bookingsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/bookings`));
                    const customers = {}; // Dùng object để gộp
                    
                    bookingsSnapshot.forEach(doc => {
                        const b = doc.data();
                        const key = b.clientId || b.contactDetail; // Ưu tiên userId
                        if (!key) return;
                        
                        if (!customers[key]) {
                            customers[key] = {
                                userId: b.clientId || '',
                                name: b.clientName,
                                contact: b.contactDetail,
                                recentServices: b.serviceName || '', // Cần thêm field này
                                type: 'new'
                            };
                        } else {
                            customers[key].name = b.clientName; // Luôn cập nhật tên mới nhất
                            customers[key].contact = b.contactDetail;
                        }
                    });
                    
                    const batch = writeBatch(db);
                    const customersRef = collection(db, `artifacts/${appId}/public/data/customers`);
                    let count = 0;
                    
                    for (const key in customers) {
                        const c = customers[key];
                        // Dùng contact làm ID doc nếu không có userId, để tránh trùng lặp
                        const docId = c.userId || c.contact.replace(/[^a-zA-Z0-9]/g, ''); 
                        if (docId) {
                            batch.set(doc(customersRef, docId), c, { merge: true });
                            count++;
                        }
                    }
                    
                    await batch.commit();
                    showAlert("Thành công", `Đã đồng bộ ${count} khách hàng.`);
                    loadCrm();
                    
                } catch (error) {
                    console.error("Lỗi đồng bộ: ", error);
                    showAlert("Lỗi", "Đồng bộ thất bại.");
                }
            });
        });
        
        // Tải xuống
        document.getElementById('export-customers').addEventListener('click', async () => {
            try {
                const snapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/customers`));
                const data = [];
                snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `customers_export_${getTodayString()}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
                
            } catch (error) { showAlert("Lỗi", "Không thể tải xuống."); }
        });
        
        // Tải lên
        document.getElementById('import-customers').addEventListener('click', () => {
            document.getElementById('customer-file-input').click();
        });
        document.getElementById('customer-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const customers = JSON.parse(event.target.result);
                    if (!Array.isArray(customers)) throw new Error("File không phải là một mảng JSON.");
                    
                    showConfirm("Xác nhận Tải lên", `Bạn có chắc muốn tải lên ${customers.length} khách hàng?`, async () => {
                        const batch = writeBatch(db);
                        const customersRef = collection(db, `artifacts/${appId}/public/data/customers`);
                        
                        customers.forEach(c => {
                            const docId = c.id || c.contact.replace(/[^a-zA-Z0-9]/g, ''); // Dùng ID cũ hoặc tạo mới
                            if (c.id) delete c.id; // Xoá id khỏi data
                            if(docId) {
                                batch.set(doc(customersRef, docId), c, { merge: true });
                            }
                        });
                        
                        await batch.commit();
                        showAlert("Thành công", `Đã tải lên ${customers.length} khách hàng.`);
                        loadCrm();
                    });
                    
                } catch (error) {
                    console.error("Lỗi đọc file: ", error);
                    showAlert("Lỗi", "File JSON không hợp lệ. " + error.message);
                } finally {
                    e.target.value = null; // Reset input
                }
            };
            reader.readAsText(file);
        });

        // --- Hàm Khởi chạy (Main) ---
        
        async function main() {
            // Khởi tạo Firebase
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // Gán sự kiện cho điều hướng chính
                document.querySelectorAll('.admin-nav-button').forEach(button => {
                    button.addEventListener('click', () => {
                        const pageId = button.dataset.page;
                        showAdminPage(pageId);
                        if (window.innerWidth < 768) { // md breakpoint
                            toggleSidebar();
                        }
                    });
                });

                // (MỚI) Gán sự kiện cho Quick Access
                document.querySelectorAll('.admin-nav-button-quick').forEach(btn => {
                    btn.addEventListener('click', () => showAdminPage(btn.dataset.page));
                });
                document.getElementById('quick-add-booking').addEventListener('click', () => {
                    // Kích hoạt modal thêm lịch hẹn thủ công
                    document.getElementById('open-manual-booking-modal').click();
                });
                document.getElementById('quick-add-tech').addEventListener('click', () => {
                    // Kích hoạt modal thêm nhân sự
                    document.getElementById('open-technician-modal').click();
                });
                
                initAuth(); // Khởi tạo xác thực
                
            } catch (error) {
                console.error("Lỗi khởi tạo Firebase:", error);
                document.body.innerHTML = 
                    '<div class="p-4 text-red-600">Lỗi kết nối đến máy chủ. Vui lòng tải lại trang.</div>';
                return;
            }
        }
        
        // Chạy khi DOM đã sẵn sàng
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>